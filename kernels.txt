{
  "schemaVersion": "2.2",
  "description": "Reduce the number of legacy kernels to 1 on Linux-based EC2 instances and update default retention setting.",
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "ReduceLegacyKernels",
      "inputs": {
        "runCommand": [
          "echo 'Updating kernel retention setting in yum configuration...'",
          "if grep -q '^installonly_limit=' /etc/yum.conf; then",
          "  sed -i 's/^installonly_limit=.*/installonly_limit=1/' /etc/yum.conf",
          "else",
          "  echo 'installonly_limit=1' >> /etc/yum.conf",
          "fi",
          "echo 'Kernel retention setting updated to 1.'",
          "",
          "echo 'Checking number of installed kernels...'",
          "kernels=$(rpm -q kernel | wc -l)",
          "echo \"Number of installed kernels: $kernels\"",
          "if [ \"$kernels\" -gt 1 ]; then",
          "  echo 'More than 1 kernel installed. Proceeding to remove older kernels...'",
          "  package-cleanup --oldkernels --count=1 -y",
          "  echo 'Old kernels removed, only the latest kernel retained.'",
          "else",
          "  echo 'Only 1 kernel present. No action needed.'",
          "fi"
        ]
      }
    }
  ]
}
