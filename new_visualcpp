{
  "schemaVersion": "2.2",
  "description": "Remove all older Visual C++ installations if the latest version (extracted from the provided URL) is installed. If the latest version is not installed, log and do nothing. Enhanced logging and post-uninstallation verification added.",
  "mainSteps": [
    {
      "action": "aws:runPowerShellScript",
      "name": "RemoveOldVisualCPP",
      "inputs": {
        "runCommand": [
          "# Define the URL that contains the latest Visual C++ version information",
          "$url = \"https://learn.microsoft.com/en-us/cpp/windows/latest-supported-vc-redist?view=msvc-170\"",
          "Write-Output \"Fetching latest Visual C++ version from $url...\"",
          "",
          "try {",
          "    $response = Invoke-WebRequest -Uri $url -UseBasicParsing",
          "    $content = $response.Content",
          "    # Extract the version from a line like: \"The latest version is 14.42.34438.0\"",
          "    $regex = [regex]'The latest version is\\s+([0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)'",
          "    $match = $regex.Match($content)",
          "    if ($match.Success) {",
          "        $latestVersion = [version]$match.Groups[1].Value",
          "        Write-Output \"Latest Visual C++ version determined from website: $latestVersion\"",
          "    } else {",
          "        Write-Output \"Unable to find the latest version information on the website. Exiting.\"",
          "        exit 0",
          "    }",
          "} catch {",
          "    Write-Output \"Error fetching or parsing the latest version from URL: $($_.Exception.Message). Exiting.\"",
          "    exit 0",
          "}",
          "",
          "# Query installed Visual C++ packages from the registry",
          "Write-Output \"Querying installed Visual C++ installations...\"",
          "$programs = Get-ItemProperty 'HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*', 'HKLM:\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*' -ErrorAction SilentlyContinue |",
          "    Where-Object { $_.DisplayName -like 'Microsoft Visual C++*' }",
          "Write-Output \"Found $($programs.Count) Visual C++ installations.\"",
          "",
          "# Check if the latest version is installed",
          "$hasLatest = $false",
          "foreach ($program in $programs) {",
          "    if ($program.DisplayVersion) {",
          "        try {",
          "            $currentVersion = [version]$program.DisplayVersion",
          "            if ($currentVersion -eq $latestVersion) {",
          "                $hasLatest = $true",
          "                break",
          "            }",
          "        } catch {",
          "            Write-Output \"Error parsing version for $($program.DisplayName). Skipping.\"",
          "        }",
          "    }",
          "}",
          "",
          "if (-not $hasLatest) {",
          "    Write-Output \"Latest Visual C++ version $latestVersion is not installed. No removals will be performed.\"",
          "    exit 0",
          "}",
          "",
          "Write-Output \"Latest Visual C++ version is installed. Proceeding to remove older versions...\"",
          "",
          "# Loop through each installed Visual C++ and remove if its version does not match the latest",
          "foreach ($program in $programs) {",
          "    try {",
          "        if ($program.DisplayVersion) {",
          "            $currentVersion = [version]$program.DisplayVersion",
          "            if ($currentVersion -ne $latestVersion) {",
          "                Write-Output \"Attempting to remove $($program.DisplayName) (version $($program.DisplayVersion)).\"",
          "                if ($program.UninstallString) {",
          "                    $uninstallCmd = $program.UninstallString",
          "                    # Log the uninstall command",
          "                    Write-Output \"Uninstall command: $uninstallCmd\"",
          "                    if ($uninstallCmd -notlike '*quiet*') {",
          "                        $uninstallCmd += ' /quiet /norestart'",
          "                    }",
          "                    try {",
          "                        $process = Start-Process -FilePath 'cmd.exe' -ArgumentList '/c', $uninstallCmd -Wait -PassThru -ErrorAction Stop",
          "                        # Wait briefly to allow uninstall to complete",
          "                        Start-Sleep -Seconds 10",
          "                        # Re-check the registry for the package",
          "                        $stillInstalled = Get-ItemProperty 'HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*', 'HKLM:\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*' -ErrorAction SilentlyContinue |",
          "                            Where-Object { $_.DisplayName -eq $program.DisplayName }",
          "                        if ($stillInstalled) {",
          "                            Write-Output \"Package $($program.DisplayName) (version $($program.DisplayVersion)) still present after uninstall attempt.\"",
          "                        } else {",
          "                            Write-Output \"Successfully removed $($program.DisplayName) (version $($program.DisplayVersion)).\"",
          "                        }",
          "                    } catch {",
          "                        Write-Output \"Error executing uninstall command for $($program.DisplayName): $($_.Exception.Message)\"",
          "                    }",
          "                } else {",
          "                    Write-Output \"No uninstall string found for $($program.DisplayName).\"",
          "                }",
          "            } else {",
          "                Write-Output \"Retaining $($program.DisplayName) as it matches the latest version ($($program.DisplayVersion)).\"",
          "            }",
          "        }",
          "    } catch {",
          "        Write-Output \"Error processing $($program.DisplayName): $($_.Exception.Message)\"",
          "    }",
          "}",
          "Write-Output \"Visual C++ removal script completed.\""
        ]
      }
    }
  ]
}
