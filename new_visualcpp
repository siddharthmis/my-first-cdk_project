{
  "schemaVersion": "2.2",
  "description": "Remove all older Visual C++ installations (if the latest version provided as a parameter is installed) by normalizing version strings and adjusting uninstall commands (e.g. converting MSI /I to /X).",
  "parameters": {
    "LatestVersion": {
      "type": "String",
      "description": "The latest Visual C++ version to retain. Older versions will be removed if this version is present (e.g., \"14.42.34438.0\").",
      "default": "14.42.34438.0"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runPowerShellScript",
      "name": "RemoveOldVisualCPP",
      "inputs": {
        "runCommand": [
          "# Helper function to normalize version strings",
          "function Normalize-Version($verString) {",
          "    if ([string]::IsNullOrEmpty($verString)) { return $null }",
          "    $parts = $verString.Split('.')",
          "    if ($parts.Length -eq 3) {",
          "        $verString = \"$verString.0\"",
          "    }",
          "    try {",
          "        return [version]$verString",
          "    } catch {",
          "        Write-Output \"Error converting version string '$verString' to [version] object.\"",
          "        return $null",
          "    }",
          "}",
          "",
          "# Retrieve and normalize the latest version from the parameter",
          "$latestVersionParam = \"{{ LatestVersion }}\"",
          "$latestVersion = Normalize-Version $latestVersionParam",
          "if ($latestVersion -eq $null) {",
          "    Write-Output \"Invalid LatestVersion parameter: $latestVersionParam. Exiting.\"",
          "    exit 1",
          "}",
          "Write-Output \"Latest Visual C++ version (normalized): $latestVersion\"",
          "",
          "# Query installed Visual C++ packages from the registry",
          "Write-Output \"Querying installed Visual C++ installations...\"",
          "$programs = Get-ItemProperty 'HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*',",
          "                             'HKLM:\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*' -ErrorAction SilentlyContinue |",
          "    Where-Object { $_.DisplayName -like 'Microsoft Visual C++*' }",
          "Write-Output \"Found $($programs.Count) Visual C++ installations.\"",
          "",
          "# Check if the latest version is installed",
          "$hasLatest = $false",
          "foreach ($program in $programs) {",
          "    if ($program.DisplayVersion) {",
          "        $currentVersion = Normalize-Version $program.DisplayVersion",
          "        if ($currentVersion -eq $latestVersion) {",
          "            $hasLatest = $true",
          "            break",
          "        }",
          "    }",
          "}",
          "",
          "if (-not $hasLatest) {",
          "    Write-Output \"Latest Visual C++ version $latestVersion is not installed. No removals will be performed.\"",
          "    exit 0",
          "}",
          "",
          "Write-Output \"Latest Visual C++ version is installed. Proceeding to remove older versions...\"",
          "",
          "# Loop through each installed Visual C++ and remove if its version does not match the latest",
          "foreach ($program in $programs) {",
          "    try {",
          "        if ($program.DisplayVersion) {",
          "            $currentVersion = Normalize-Version $program.DisplayVersion",
          "            if ($currentVersion -and $currentVersion -ne $latestVersion) {",
          "                Write-Output \"Attempting to remove $($program.DisplayName) (version $($program.DisplayVersion)).\"",
          "                if ($program.UninstallString) {",
          "                    $uninstallCmd = $program.UninstallString",
          "                    Write-Output \"Original uninstall command: $uninstallCmd\"",
          "                    ",
          "                    # If the uninstall command uses msiexec and has /I, replace it with /X for uninstallation",
          "                    if ($uninstallCmd -match \"msiexec.exe\" -and $uninstallCmd -match \"/I\" -and -not ($uninstallCmd -match \"/X\")) {",
          "                        Write-Output \"Detected MSI installer with /I flag. Replacing /I with /X for proper uninstallation.\"",
          "                        $uninstallCmd = $uninstallCmd -replace \"/I\", \"/X\"",
          "                    }",
          "                    ",
          "                    # Append /quiet /norestart if not already present",
          "                    if ($uninstallCmd -notmatch \"/quiet\") {",
          "                        $uninstallCmd += \" /quiet /norestart\"",
          "                    }",
          "                    Write-Output \"Final uninstall command: $uninstallCmd\"",
          "                    ",
          "                    try {",
          "                        $process = Start-Process -FilePath 'cmd.exe' -ArgumentList '/c', $uninstallCmd -Wait -PassThru -ErrorAction Stop",
          "                        # Wait briefly to allow uninstall to complete",
          "                        Start-Sleep -Seconds 10",
          "                        # Re-check the registry for the package",
          "                        $stillInstalled = Get-ItemProperty 'HKLM:\\Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*',",
          "                                                     'HKLM:\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*' -ErrorAction SilentlyContinue |",
          "                            Where-Object { $_.DisplayName -eq $program.DisplayName }",
          "                        if ($stillInstalled) {",
          "                            Write-Output \"Package $($program.DisplayName) (version $($program.DisplayVersion)) still present after uninstall attempt.\"",
          "                        } else {",
          "                            Write-Output \"Successfully removed $($program.DisplayName) (version $($program.DisplayVersion)).\"",
          "                        }",
          "                    } catch {",
          "                        Write-Output \"Error executing uninstall command for $($program.DisplayName): $($_.Exception.Message)\"",
          "                    }",
          "                } else {",
          "                    Write-Output \"No uninstall string found for $($program.DisplayName).\"",
          "                }",
          "            } else {",
          "                Write-Output \"Retaining $($program.DisplayName) as it matches the latest version ($($program.DisplayVersion)).\"",
          "            }",
          "        }",
          "    } catch {",
          "        Write-Output \"Error processing $($program.DisplayName): $($_.Exception.Message)\"",
          "    }",
          "}",
          "Write-Output \"Visual C++ removal script completed.\""
        ]
      }
    }
  ]
}
